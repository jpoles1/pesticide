<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>D3 Loan Map -- Jordan Poles</title>
  <!--<link type="text/css" rel="stylesheet" href="jquery.qtip.min.css" />-->
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
  <!--<script src="colorbrewer.js"></script>
  <script src="jquery.qtip.min.js"></script>-->
  <style>
  body {
    margin:0;
    padding:20px;
    width: 1200px;
  }
  #map {
    display:block;
    width:840px;
    height:600px;
  }
  #map .active {
    fill: orange;
  }
  svg{
    cursor: crosshair;
  }
  </style>
</head>

<body>
  <div id="left-pane" style="width: 840px; float: left; display: inline;">
    <h1>Global Pesticide Use</h1>
    <div id="map"></div>
  </div>
  <div id="right-pane" style="width: 30%; float: left; display: inline;">
    <h1>Pesticide Use over Time</h1>
  </div>
</body>
<script>
  //Setup Map Space
  var width = 800,
    height = 500,
    centered;
  projection = d3.geo.mercator()
    .scale((width) / 2.1 / Math.PI)
    .translate([width / 2, height / 1.5])
    .precision(.1);
  path = d3.geo.path().projection(projection);
  mapsvg = d3.select("#map").append("svg")
    .attr("width", width)
    .attr("height", height)
  mapsvg.append("rect")
      .attr("class", "svgbg")
      .attr("width", width)
      .attr("height", height)
      .on("click", clicked)
      .attr("fill", "#333")
  mapsvg = mapsvg.append("g")

  //Setup Legend
  /*var legend = d3.select('#legend').attr("style", "left:"+(width+100)+"px").append('ul').append("div").attr('class', 'list-inline')
  var datavars = ["Recipients", "amt disbursed", "Population"]
  var prettynames = ["# of Loans", "$ Disbursed", "State Pop."]
  var varselect = d3.select("#legend select")
  for(i in datavars){
    varselect.append("option").attr("value", datavars[i]).text(prettynames[i])
  }*/
  //Drawing function
  function pathAnimate(selector) {
    $(selector).each(function(){
      var speed = 2.5; // seconds
      var path = $(this).get(0);
      var length = path.getTotalLength();

      path.style.strokeDasharray = length + ' ' + length;
      path.style.strokeDashoffset = length;
      path.style.transition = path.style.WebkitTransition = 'none';

      path.getBoundingClientRect();
      path.style.transition = path.style.WebkitTransition = 'stroke-dashoffset ' + speed + 's ease';
      path.style.strokeDashoffset = '0';
    });
  };
  function clicked(d) {

    //Zooming logic
    var x, y, k;
    if (d && centered !== d) {
      var centroid = path.centroid(d);
      x = centroid[0];
      y = centroid[1];
      k = 4;
      centered = d;
    } else {
      x = width / 2;
      y = height / 2;
      k = 1;
      centered = null;
    }
    mapsvg.selectAll("path")
        .classed("active", centered && function(d) { return d === centered; });
    mapsvg.transition()
        .duration(750)
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
        .style("stroke-width", 1.5 / k + "px");
  }
  function drawMap(countrydata, pesticidedata){
    //Add Map Paths & Fill
    console.log(countrydata)
    mapsvg.html("").selectAll("path").data(countrydata.features).enter()
       .append("path").attr("class", "countrypath").attr("d", path)
       .attr("name", function(d){return d.properties.name_long})
       .attr("stroke", "black").attr("fill", "white")
       .attr("id", function(d){return d.properties.name_long.replace(/\s/g, "")})
       .on("click", clicked);
  }
  //Load Geodata
  d3.json("countries.geojson", function(error,countrydata) {
    if(error) alert(error)
    //Load dataset
    d3.json("pesticide.json", function(error, pesticidedata){
      if(error) alert(error)
      //Run
      drawMap(countrydata, pesticidedata)
      pathAnimate(".countrypath")
      drawMore()
    });
  });
</script>
</html>
